<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Likes Goal Widget</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&display.swap');

        /* * This widget is designed for a 1920x1080 canvas.
         * The body has no margin to ensure precise positioning within OBS.
        */
        body, html {
            margin: 0;
            padding: 0;
            width: 1920px;
            height: 1080px;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            overflow: hidden;
            color: #ffffff;
        }

        /* Main container for the widget, positioned at the lower-right corner and scaled down */
        #widget-container {
            position: absolute;
            bottom: 25px;
            right: 25px; /* Changed from left to right */
            background-color: #38B6FF; /* Changed to the new blue */
            padding: 5px 2px; /* Decreased top/bottom padding */
            border: 1px solid #38B6FF; /* Changed border color */
            transition: background-color 0.5s ease, transform 0.3s ease-in-out;
        }
        
        #widget-container.celebrating {
            background-color: #28a745;
        }
        
        /* The view that shows the like count, scaled down */
        #likes-display {
            display: flex;
            align-items: center; 
            font-size: 44px; /* Increased font size by 10% */
            font-weight: 700;
            position: relative; /* Needed for positioning animation views */
            min-width: 220px; /* Adjusted width to ensure single-line display */
            min-height: 46px; /* Decreased height for tighter margin */
            overflow: hidden; /* Hide the sliding elements */
        }
        
        /* Container for the views that will be animated */
        .animated-view {
            display: flex;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: flex-start; /* Default to left align */
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Changed from opacity to transform */
        }
        
        #likes-view {
            transform: translateY(0);
            justify-content: center; /* Override to center align only the likes view */
        }

        #goal-view, #congrats-view {
            transform: translateY(100%); /* Start positioned below the container */
        }

        #congrats-view {
            background-color: transparent; /* Parent container handles color now */
            width: 100%;
            height: 100%;
            justify-content: center; /* Center the text */
        }

        #goal-view span {
             font-size: 31px; /* Increased font size by 20% */
        }

        #congrats-view span {
            font-size: 28.5px; /* Decreased by 5% */
            font-weight: bold;
            white-space: nowrap;
            text-align: center;
            width: 100%;
        }

        /* State class to trigger the animation */
        #likes-display.show-goal #likes-view {
            transform: translateY(-100%); /* Slide up */
        }
        
        #likes-display.show-goal #goal-view {
            transform: translateY(0); /* Slide in */
        }
        
        /* State for the congratulations animation */
        #likes-display.show-congrats #likes-view {
            transform: translateY(-100%); /* Slide the likes view up and out */
        }
        #likes-display.show-congrats #congrats-view {
             transform: translateY(0); /* Slide in */
        }
        
        /* Styling for the like emoji SVG, scaled down */
        .icon {
            width: 25px; /* Scaled down */
            height: 25px; /* Scaled down */
            margin-right: 8px; /* Scaled down */
        }

        /* Initial settings/configuration view, scaled down */
        #settings-view {
            width: 175px; /* Scaled down */
        }

        #settings-view h3 {
            margin-top: 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px; /* Scaled down */
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 8px; /* Scaled down */
        }

        .input-group label {
            display: block;
            margin-bottom: 3px; /* Scaled down */
            font-size: 12px; /* Scaled down */
            color: #cccccc;
        }

        .input-group input {
            width: 100%;
            padding: 5px; /* Scaled down */
            border: 1px solid #555;
            background-color: #222;
            color: #fff;
            box-sizing: border-box;
            font-size: 12px;
        }
        
        button {
            width: 100%;
            padding: 6px; /* Scaled down */
            border: none;
            background-color: #4a90e2;
            color: white;
            font-weight: bold;
            font-size: 14px; /* Scaled down */
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #357abd;
        }

        #error-message {
            color: #ff4d4d;
            font-size: 12px; /* Scaled down */
            margin-top: 5px; /* Scaled down */
            text-align: center;
            min-height: 15px; /* Scaled down */
        }
        
        /* A small gear icon to reopen settings, scaled down */
        #reopen-settings {
            position: absolute;
            top: -5px; /* Scaled down */
            right: -5px; /* Scaled down */
            width: 20px; /* Scaled down */
            height: 20px; /* Scaled down */
            background-color: #333;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        #likes-display:hover #reopen-settings {
             opacity: 1;
        }

        /* Utility class to hide elements */
        .hidden {
            display: none !important;
        }

        /* Confetti Styles */
        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 100;
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 16px;
            top: -20px; /* Start above the container */
            opacity: 0;
            animation: fall 4s linear forwards;
        }

        @keyframes fall {
            0% { transform: translateY(0px) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100px) rotateZ(720deg); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="widget-container">
        <div id="confetti-container"></div>
        <!-- SETTINGS VIEW: Shown on start to get user input --><div id="settings-view">
            <h3>Likes Widget Setup</h3>
            <div class="input-group">
                <label for="apiKey">YouTube API Key</label>
                <input type="text" id="apiKey" placeholder="Enter your YouTube API Key">
            </div>
            <div class="input-group">
                <label for="videoUrl">YouTube Video URL or ID</label>
                <input type="text" id="videoUrl" placeholder="e.g., dQw4w9WgXcQ">
            </div>
            <div class="input-group">
                <label for="likeGoal">Initial Like Goal</label>
                <input type="number" id="likeGoal" placeholder="e.g., 100" value="100">
            </div>
            <button id="start-btn">Start Tracking</button>
            <p id="error-message"></p>
        </div>

        <!-- LIKES DISPLAY VIEW: Shown after setup is complete --><div id="likes-display" class="hidden">
            <div id="likes-view" class="animated-view">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M7 10v12"></path>
                    <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 1.79 1.11L15 5.88Z"></path>
                </svg>
                <span id="like-count">...</span>
            </div>
            <div id="goal-view" class="animated-view">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                <span id="goal-text">Goal = 100</span>
            </div>
            <div id="congrats-view" class="animated-view">
                <span>Congratulations!</span>
            </div>
            <div id="reopen-settings" title="Change Settings">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82-.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H15a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V15a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51-1z"></path></svg>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const widgetContainer = document.getElementById('widget-container');
            const settingsView = document.getElementById('settings-view');
            const likesDisplay = document.getElementById('likes-display');
            const startBtn = document.getElementById('start-btn');
            const reopenSettingsBtn = document.getElementById('reopen-settings');
            const apiKeyInput = document.getElementById('apiKey');
            const videoUrlInput = document.getElementById('videoUrl');
            const likeGoalInput = document.getElementById('likeGoal');
            const likeCountSpan = document.getElementById('like-count');
            const goalTextSpan = document.getElementById('goal-text');
            const errorMessage = document.getElementById('error-message');
            const confettiContainer = document.getElementById('confetti-container');


            const API_KEY_STORAGE_KEY = 'youtube_widget_api_key';
            const VIDEO_ID_STORAGE_KEY = 'youtube_widget_video_id';
            const GOAL_STORAGE_KEY = 'youtube_widget_goal';
            
            let apiKey = '';
            let videoId = '';
            let currentGoal = 100;
            let goalReachedLock = false; // Prevents multiple triggers
            let updateInterval = null;
            let animationTimeout = null;
            let confettiInterval = null;
            
            const UPDATE_FREQUENCY_MS = 10000;
            const LIKES_DISPLAY_DURATION_MS = 20000; // 20 seconds
            const GOAL_DISPLAY_DURATION_MS = 10000; // 10 seconds
            const CONGRATS_DISPLAY_DURATION_MS = 120000; // 120 seconds

            function extractVideoId(url) {
                if (!url) return null;
                const standaloneIdRegex = /^[a-zA-Z0-9_-]{11}$/;
                if (standaloneIdRegex.test(url)) return url;
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }
            
            function createConfettiParticle() {
                const colors = ['#dc3545', '#007bff', '#ffc107', '#ffffff']; // Red, Blue, Yellow, White

                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animationDuration = `${Math.random() * 2 + 3}s`; // Fall duration between 3-5s
                
                confettiContainer.appendChild(confetti);

                // Remove the element after it has fallen
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }

            function triggerCongratsAnimation() {
                goalReachedLock = true;
                if (animationTimeout) clearTimeout(animationTimeout); // Pause regular animation

                likesDisplay.classList.remove('show-goal'); // Ensure congrats starts from like view
                widgetContainer.classList.add('celebrating');
                likesDisplay.classList.add('show-congrats');
                
                // Start confetti
                confettiInterval = setInterval(createConfettiParticle, 150);

                setTimeout(() => {
                    widgetContainer.classList.remove('celebrating');
                    likesDisplay.classList.remove('show-congrats');
                    
                    // Stop confetti
                    clearInterval(confettiInterval);
                    confettiContainer.innerHTML = '';
                    
                    currentGoal += 100;
                    localStorage.setItem(GOAL_STORAGE_KEY, currentGoal);
                    updateGoalText();
                    goalReachedLock = false;
                    
                    // Restart the regular goal animation
                    startLikeGoalRotation();
                }, CONGRATS_DISPLAY_DURATION_MS);
            }

            async function fetchLikeCount() {
                if (!apiKey || !videoId || goalReachedLock) return;
                const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        const errorData = await response.json();
                        const reason = errorData.error.errors[0]?.reason || 'unknown';
                        throw new Error(`API Error: ${response.status} (${reason})`);
                    }
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        const likeCount = parseInt(data.items[0].statistics.likeCount);
                        likeCountSpan.textContent = likeCount.toLocaleString('en-US');
                        errorMessage.textContent = '';
                        
                        // Check if the goal is met
                        if (likeCount >= currentGoal) {
                            triggerCongratsAnimation();
                        }
                    } else {
                        throw new Error("Video not found.");
                    }
                } catch (error) {
                    console.error('Failed to fetch like count:', error);
                    let detailedError = error.message;
                     if (error.message.includes('Failed to fetch')) {
                        detailedError = 'Network error. Check API key validity/restrictions or internet connection.';
                    }
                    errorMessage.textContent = `Error: ${detailedError}`;
                    likeCountSpan.textContent = 'Error'; 
                }
            }
            
            function startLikeGoalRotation() {
                if (goalReachedLock) return;
                
                // Show Likes View
                likesDisplay.classList.remove('show-goal');
                
                // Set timer to show Goal View
                if (animationTimeout) clearTimeout(animationTimeout);
                animationTimeout = setTimeout(() => {
                    showGoalView();
                }, LIKES_DISPLAY_DURATION_MS);
            }

            function showGoalView() {
                if (goalReachedLock) return;
                
                // Show Goal View
                likesDisplay.classList.add('show-goal');
                
                // Set timer to show Likes View (restarting the loop)
                if (animationTimeout) clearTimeout(animationTimeout);
                animationTimeout = setTimeout(() => {
                    startLikeGoalRotation();
                }, GOAL_DISPLAY_DURATION_MS);
            }

            function updateGoalText() {
                goalTextSpan.textContent = `Goal = ${currentGoal.toLocaleString('en-US')}`;
            }

            function startTracking() {
                errorMessage.textContent = '';
                apiKey = apiKeyInput.value.trim();
                videoId = extractVideoId(videoUrlInput.value.trim());
                currentGoal = parseInt(likeGoalInput.value) || 100;

                if (!apiKey) {
                    errorMessage.textContent = 'Please enter a YouTube API Key.';
                    return;
                }
                if (!videoId) {
                    errorMessage.textContent = 'Invalid YouTube URL or Video ID.';
                    return;
                }
                
                localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
                localStorage.setItem(VIDEO_ID_STORAGE_KEY, videoId);
                localStorage.setItem(GOAL_STORAGE_KEY, currentGoal);
                goalReachedLock = false;

                updateGoalText();
                settingsView.classList.add('hidden');
                likesDisplay.classList.remove('hidden');

                fetchLikeCount();
                if (updateInterval) clearInterval(updateInterval);
                if (animationTimeout) clearTimeout(animationTimeout);

                updateInterval = setInterval(fetchLikeCount, UPDATE_FREQUENCY_MS);
                startLikeGoalRotation();
            }

            function showSettings() {
                 if (updateInterval) clearInterval(updateInterval);
                 if (animationTimeout) clearTimeout(animationTimeout);
                 if (confettiInterval) clearInterval(confettiInterval);
                 likesDisplay.classList.add('hidden');
                 settingsView.classList.remove('hidden');
                 likeCountSpan.textContent = '...';
                 likesDisplay.classList.remove('show-goal', 'show-congrats');
            }
            
            function initializeWidget() {
                const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
                const savedVideoId = localStorage.getItem(VIDEO_ID_STORAGE_KEY);
                const savedGoal = localStorage.getItem(GOAL_STORAGE_KEY);

                apiKeyInput.value = savedApiKey || 'AIzaSyDawXMms4chr_q7ZmyvgP7jWZ9zkfk5QuE';
                if (savedVideoId) videoUrlInput.value = savedVideoId;
                if (savedGoal) likeGoalInput.value = savedGoal;
                
                if (apiKeyInput.value.trim() && savedVideoId) {
                    startTracking();
                }
            }
            
            startBtn.addEventListener('click', startTracking);
            reopenSettingsBtn.addEventListener('click', showSettings);
            [apiKeyInput, videoUrlInput, likeGoalInput].forEach(input => {
                 input.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') startTracking();
                });
            });

            initializeWidget();
        });
    </script>
</body>
</html>



